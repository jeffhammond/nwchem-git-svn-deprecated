      SUBROUTINE ccsd_t2_8(d_a,k_a_offset,d_b,k_b_offset,d_c,k_c_offset)
C     $Id: ccsd_t2.F 27404 2015-08-24 14:20:43Z jhammond $
C     This is a Fortran77 program generated by Tensor Contraction Engine v.1.0
C     Copyright (c) Battelle & Pacific Northwest National Laboratory (2002)
C     i0 ( p3 p4 h1 h2 )_vt + = 1/2 * Sum ( p5 p6 ) * t ( p5 p6 h1 h2 )_t * v ( p3 p4 p5 p6 )_v
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a
      INTEGER k_a_offset
      INTEGER d_b
      INTEGER k_b_offset
      INTEGER d_c
      INTEGER k_c_offset
      INTEGER NXTASK
      INTEGER next
      INTEGER nprocs
      INTEGER count
      INTEGER p3b
      INTEGER p4b
      INTEGER h1b
      INTEGER h2b
      INTEGER dimc
      INTEGER l_cs
      INTEGER k_cs
      INTEGER p5b
      INTEGER p6b
      INTEGER p5b_1
      INTEGER p6b_1
      INTEGER h1b_1
      INTEGER h2b_1
      INTEGER p3b_2
      INTEGER p4b_2
      INTEGER p5b_2
      INTEGER p6b_2
      INTEGER dim_common
      INTEGER dima_sort
      INTEGER dima
      INTEGER dimb_sort
      INTEGER dimb
      INTEGER l_as
      INTEGER k_as
      INTEGER l_a
      INTEGER k_a
      INTEGER l_bs
      INTEGER k_bs
      INTEGER l_b
      INTEGER k_b
      INTEGER nsuperp(2)
      INTEGER isuperp
      INTEGER l_c
      INTEGER k_c
      DOUBLE PRECISION FACTORIAL
      EXTERNAL NXTASK
      EXTERNAL FACTORIAL
      nprocs = GA_NNODES()
      count = 0
      next = NXTASK(nprocs, 1)
      DO p3b = noab+1,noab+nvab
      DO p4b = p3b,noab+nvab
      DO h1b = 1,noab
      DO h2b = h1b,noab
      IF ((.not.restricted).or.(int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1
     &)+int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1).ne.8)) THEN
      IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq. int_mb(k_spin+h
     &1b-1)+int_mb(k_spin+h2b-1)) THEN
      IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),ieor(int_mb(
     &k_sym+h1b-1),int_mb(k_sym+h2b-1)))) .eq. ieor(irrep_v,irrep_t)) TH
     &EN
      IF (next.eq.count) THEN
      dimc = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1) * int_mb(k_ra
     &nge+h1b-1) * int_mb(k_range+h2b-1)
      IF (.not.MA_PUSH_GET(mt_dbl,dimc,'cs',l_cs,k_cs)) CALL
     & ERRQUIT('ccsd_t2_8',0,MA_ERR)
      CALL DFILL(dimc,0.0d0,dbl_mb(k_cs),1)
      DO p5b = noab+1,noab+nvab
      DO p6b = p5b,noab+nvab
      IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1) .eq. int_mb(k_spin+h
     &1b-1)+int_mb(k_spin+h2b-1)) THEN
      IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),ieor(int_mb(
     &k_sym+h1b-1),int_mb(k_sym+h2b-1)))) .eq. irrep_t) THEN
      CALL TCE_RESTRICTED_4(p5b,p6b,h1b,h2b,p5b_1,p6b_1,h1b_1,h2b_1)
      CALL TCE_RESTRICTED_4(p3b,p4b,p5b,p6b,p3b_2,p4b_2,p5b_2,p6b_2)
      dim_common = int_mb(k_range+p5b-1) * int_mb(k_range+p6b-1)
      dima_sort = int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1)
      dima = dim_common * dima_sort
      dimb_sort = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1)
      dimb = dim_common * dimb_sort
      IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
      IF (.not.MA_PUSH_GET(mt_dbl,dima,'as',l_as,k_as)) CALL
     & ERRQUIT('ccsd_t2_8',1,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,dima,'a',l_a,k_a)) CALL ERRQUIT('
     &ccsd_t2_8',2,MA_ERR)
      CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,int_mb(k_a_offset),(h2b_1
     & - 1 + noab * (h1b_1 - 1 + noab * (p6b_1 - noab - 1 + nvab * (p5b_
     &1 - noab - 1)))))
      CALL TCE_SORT_4(dbl_mb(k_a),dbl_mb(k_as),int_mb(k_range+p5b-1)
     &,int_mb(k_range+p6b-1),int_mb(k_range+h1b-1),int_mb(k_range+h2b-1)
     &,4,3,2,1,1.0d0)
      IF (.not.MA_POP_STACK(l_a)) CALL ERRQUIT('ccsd_t2_8',3,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,dimb,'bs',l_bs,k_bs)) CALL
     & ERRQUIT('ccsd_t2_8',4,MA_ERR)
      IF (.not.MA_PUSH_GET(mt_dbl,dimb,'b',l_b,k_b)) CALL ERRQUIT('
     &ccsd_t2_8',5,MA_ERR)
      if(.not.intorb) then
      CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,int_mb(k_b_offset),(p6b_2
     & - 1 + (noab+nvab) * (p5b_2 - 1 + (noab+nvab) * (p4b_2 - 1 + (noab
     &+nvab) * (p3b_2 - 1)))))
      else
      CALL GET_HASH_BLOCK_I(d_b,dbl_mb(k_b),dimb,int_mb(k_b_offset),
     &(p6b_2
     & - 1 + (noab+nvab) * (p5b_2 - 1 + (noab+nvab) * (p4b_2 - 1 + (noab
     &+nvab) * (p3b_2 - 1)))),p6b_2,p5b_2,p4b_2,p3b_2)
      end if
      CALL TCE_SORT_4(dbl_mb(k_b),dbl_mb(k_bs),int_mb(k_range+p3b-1)
     &,int_mb(k_range+p4b-1),int_mb(k_range+p5b-1),int_mb(k_range+p6b-1)
     &,2,1,4,3,1.0d0)
      IF (.not.MA_POP_STACK(l_b)) CALL ERRQUIT('ccsd_t2_8',6,MA_ERR)
      nsuperp(1) = 1
      nsuperp(2) = 1
      isuperp = 1
      IF (p5b .eq. p6b) THEN
      nsuperp(isuperp) = nsuperp(isuperp) + 1
      ELSE
      isuperp = isuperp + 1
      END IF
      CALL DGEMM('T','N',dima_sort,dimb_sort,dim_common,2.0d0/FACTORIAL(
     &nsuperp(1))/FACTORIAL(nsuperp(2)),dbl_mb(k_as),dim_common,dbl_
     &mb(k_bs),dim_common,1.0d0,dbl_mb(k_cs),dima_sort)
      IF (.not.MA_POP_STACK(l_bs)) CALL ERRQUIT('ccsd_t2_8',7,MA_ERR
     &)
      IF (.not.MA_POP_STACK(l_as)) CALL ERRQUIT('ccsd_t2_8',8,MA_ERR
     &)
      END IF
      END IF
      END IF
      END DO
      END DO
      IF (.not.MA_PUSH_GET(mt_dbl,dimc,'c',l_c,k_c)) CALL ERRQUIT('
     &ccsd_t2_8',9,MA_ERR)
      CALL TCE_SORT_4(dbl_mb(k_cs),dbl_mb(k_c),int_mb(k_range+p4b-1)
     &,int_mb(k_range+p3b-1),int_mb(k_range+h2b-1),int_mb(k_range+h1b-1)
     &,2,1,4,3,1.0d0/2.0d0)
      CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,int_mb(k_c_offset),(h2b -
     & 1 + noab * (h1b - 1 + noab * (p4b - noab - 1 + nvab * (p3b - noab
     & - 1)))))
      IF (.not.MA_POP_STACK(l_c)) CALL ERRQUIT('ccsd_t2_8',10,MA_ERR)
      IF (.not.MA_POP_STACK(l_cs)) CALL ERRQUIT('ccsd_t2_8',11,MA_ER
     &R)
      next = NXTASK(nprocs, 1)
      END IF
      count = count + 1
      END IF
      END IF
      END IF
      END DO
      END DO
      END DO
      END DO
      next = NXTASK(-nprocs, 1)
      call GA_SYNC()
      RETURN
      END

#ifdef USE_F90_ALLOCATABLE
#define REF2MEM(a) f_##a
#else
#define REF2MEM(a) dbl_mb(k_##a)
#endif

      SUBROUTINE ccsd_t2_8_test(d_a,k_a_offset,
     &                          d_b,k_b_offset,
     &                          d_c,k_c_offset,
     &                          maxh,maxp)
C     $Id: ccsd_t2.F 27404 2015-08-24 14:20:43Z jhammond $
C     This is a Fortran77 program generated by Tensor Contraction Engine v.1.0
C     Copyright (c) Battelle & Pacific Northwest National Laboratory (2002)
C     i0 ( p3 p4 h1 h2 )_vt + = 1/2 * Sum ( p5 p6 ) * t ( p5 p6 h1 h2 )_t * v ( p3 p4 p5 p6 )_v
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
      INTEGER d_a,d_b,d_c
      INTEGER k_a_offset,k_b_offset,k_c_offset
      INTEGER maxh,maxp,dimhhpp,dimpppp,dimtemp
      INTEGER next,nprocs,count
      INTEGER p5b,p6b,p3b,p4b,h1b,h2b
      INTEGER p5b_1,p6b_1,h1b_1,h2b_1
      INTEGER p3b_2,p4b_2,p5b_2,p6b_2
      INTEGER dima,dimb,dimc,dim_common,dima_sort,dimb_sort
#ifdef USE_F90_ALLOCATABLE
      double precision, allocatable :: f_a(:)
      double precision, allocatable :: f_b(:)
      double precision, allocatable :: f_c(:)
      double precision, allocatable :: f_t(:)
      integer :: e_a,e_b,e_c,e_t
#else
      integer k_a, l_a
      integer k_b, l_b
      integer k_c, l_c
      integer k_t, l_t
      logical e_a,e_b,e_c,e_t
#endif
      double precision alpha
      INTEGER NXTASK
      EXTERNAL NXTASK
      nprocs = GA_NNODES()
      count = 0
      next = NXTASK(nprocs, 1)

      dimhhpp = maxh*maxh*maxp*maxp
      dimpppp = maxp*maxp*maxp*maxp
      dimtemp = max(dimpppp,dimhhpp)

#ifdef USE_F90_ALLOCATABLE
      allocate(f_a(1:dimhhpp),stat=e_a)
      allocate(f_b(1:dimpppp),stat=e_b)
      allocate(f_c(1:dimhhpp),stat=e_c)
# ifndef USE_LOOPS_NOT_DGEMM
      allocate(f_t(1:dimtemp),stat=e_t)
# endif
#else
      e_a=.not.MA_PUSH_GET(mt_dbl,dimhhpp,"a",l_a,k_a)
      e_b=.not.MA_PUSH_GET(mt_dbl,dimpppp,"b",l_b,k_b)
      e_c=.not.MA_PUSH_GET(mt_dbl,dimhhpp,"c",l_c,k_c)
# ifndef USE_LOOPS_NOT_DGEMM
      e_t=.not.MA_PUSH_GET(mt_dbl,dimtemp,"t",l_t,k_t)
# else
      dimtemp=-12345
      e_t=.false.
# endif
#endif
      if (e_a) call errquit("MA a",dimhhpp,MA_ERR)
      if (e_b) call errquit("MA b",dimpppp,MA_ERR)
      if (e_c) call errquit("MA c",dimhhpp,MA_ERR)
      if (e_t) call errquit("MA t",dimtemp,MA_ERR)
      DO p3b = noab+1,noab+nvab
       DO p4b = p3b,noab+nvab
        DO h1b = 1,noab
         DO h2b = h1b,noab
          IF ((.not.restricted).or.
     &        ( int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1)
     &         +int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1).ne.8)) THEN
           IF (int_mb(k_spin+p3b-1)+int_mb(k_spin+p4b-1) .eq.
     &         int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)) THEN
            IF (ieor(int_mb(k_sym+p3b-1),ieor(int_mb(k_sym+p4b-1),
     &          ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h2b-1))))
     &                 .eq. ieor(irrep_v,irrep_t)) THEN
             IF (next.eq.count) THEN
              dima_sort = int_mb(k_range+h1b-1)
     &                  * int_mb(k_range+h2b-1)
              dimb_sort = int_mb(k_range+p3b-1)
     &                  * int_mb(k_range+p4b-1)
              dimc = int_mb(k_range+p3b-1) * int_mb(k_range+p4b-1)
     &             * int_mb(k_range+h1b-1) * int_mb(k_range+h2b-1)
#ifdef USE_F90_ALLOCATABLE
              CALL DFILL(dimc,0.0d0,f_c,1)
              DO p5b = noab+1,noab+nvab
               DO p6b = p5b,noab+nvab
                IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1) .eq.
     &              int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)) THEN
                 IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),
     &               ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h2b-1))))
     &                      .eq. irrep_t) THEN
                  CALL TCE_RESTRICTED_4(p5b,p6b,h1b,h2b,
     &                                  p5b_1,p6b_1,h1b_1,h2b_1)
                  CALL TCE_RESTRICTED_4(p3b,p4b,p5b,p6b,
     &                                  p3b_2,p4b_2,p5b_2,p6b_2)
                  dim_common = int_mb(k_range+p5b-1)
     &                       * int_mb(k_range+p6b-1)
                  dima = dim_common * dima_sort
                  dimb = dim_common * dimb_sort
                  IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
#ifdef USE_LOOPS_NOT_DGEMM
                   CALL GET_HASH_BLOCK(d_a,f_a,dima,
     &                  int_mb(k_a_offset),(h2b_1-1+noab*(h1b_1-1+noab*
     &                  (p6b_1-noab-1+nvab*(p5b_1-noab-1)))))
#else
                   CALL GET_HASH_BLOCK(d_a,f_t,dima,
     &                  int_mb(k_a_offset),(h2b_1-1+noab*(h1b_1-1+noab*
     &                  (p6b_1-noab-1+nvab*(p5b_1-noab-1)))))
                   CALL TCE_SORT_4(f_t,f_a,
     &                  int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),
     &                  int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),
     &                  4,3,2,1,1.0d0)
#endif
                   if(.not.intorb) then
#ifdef USE_LOOPS_NOT_DGEMM
                    CALL GET_HASH_BLOCK(d_b,f_b,dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))))
#else
                    CALL GET_HASH_BLOCK(d_b,f_t,dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))))
#endif
                   else
#ifdef USE_LOOPS_NOT_DGEMM
                    CALL GET_HASH_BLOCK_I(d_b,f_b,dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))),p6b_2,p5b_2,p4b_2,p3b_2)
#else
                    CALL GET_HASH_BLOCK_I(d_b,f_t,dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))),p6b_2,p5b_2,p4b_2,p3b_2)
#endif
                   end if
#ifndef USE_LOOPS_NOT_DGEMM
                   CALL TCE_SORT_4(f_t,f_b,
     &                  int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),
     &                  int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),
     &                  2,1,4,3,1.0d0)
#endif
                   if (p5b .eq. p6b) then
                    alpha = 1.0d0
                   else
                    alpha = 2.0d0
                   end if
#ifdef USE_LOOPS_NOT_DGEMM
                   call t2_p8(int_mb(k_range+h1b-1),
     &                        int_mb(k_range+h2b-1),
     &                        int_mb(k_range+p3b-1),
     &                        int_mb(k_range+p4b-1),
     &                        int_mb(k_range+p5b-1),
     &                        int_mb(k_range+p6b-1),
     &                        f_a,f_b,f_c,
     &                        0.5d0*alpha)
#else
                   CALL DGEMM('T','N',dima_sort,dimb_sort,dim_common,
     &                  alpha,f_a,dim_common,f_b,
     &                  dim_common,1.0d0,f_c,dima_sort)
#endif
                  END IF
                 END IF
                END IF
               END DO
              END DO
#ifdef USE_LOOPS_NOT_DGEMM
              CALL ADD_HASH_BLOCK(d_c,f_c,dimc,
     &             int_mb(k_c_offset),(h2b-1+noab*(h1b-1+noab*
     &             (p4b-noab-1+nvab*(p3b-noab-1)))))
#else
              CALL TCE_SORT_4(f_c,f_t,
     &             int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),
     &             int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),
     &             2,1,4,3,0.5d0)
              CALL ADD_HASH_BLOCK(d_c,f_t,dimc,
     &             int_mb(k_c_offset),(h2b-1+noab*(h1b-1+noab*
     &             (p4b-noab-1+nvab*(p3b-noab-1)))))
#endif
#else // USE_F90_ALLOCATABLE
              CALL DFILL(dimc,0.0d0,dbl_mb(k_c),1)
              DO p5b = noab+1,noab+nvab
               DO p6b = p5b,noab+nvab
                IF (int_mb(k_spin+p5b-1)+int_mb(k_spin+p6b-1) .eq.
     &              int_mb(k_spin+h1b-1)+int_mb(k_spin+h2b-1)) THEN
                 IF (ieor(int_mb(k_sym+p5b-1),ieor(int_mb(k_sym+p6b-1),
     &               ieor(int_mb(k_sym+h1b-1),int_mb(k_sym+h2b-1))))
     &                      .eq. irrep_t) THEN
                  CALL TCE_RESTRICTED_4(p5b,p6b,h1b,h2b,
     &                                  p5b_1,p6b_1,h1b_1,h2b_1)
                  CALL TCE_RESTRICTED_4(p3b,p4b,p5b,p6b,
     &                                  p3b_2,p4b_2,p5b_2,p6b_2)
                  dim_common = int_mb(k_range+p5b-1)
     &                       * int_mb(k_range+p6b-1)
                  dima = dim_common * dima_sort
                  dimb = dim_common * dimb_sort
                  IF ((dima .gt. 0) .and. (dimb .gt. 0)) THEN
#ifdef USE_LOOPS_NOT_DGEMM
                   CALL GET_HASH_BLOCK(d_a,dbl_mb(k_a),dima,
     &                  int_mb(k_a_offset),(h2b_1-1+noab*(h1b_1-1+noab*
     &                  (p6b_1-noab-1+nvab*(p5b_1-noab-1)))))
#else
                   CALL GET_HASH_BLOCK(d_a,dbl_mb(k_t),dima,
     &                  int_mb(k_a_offset),(h2b_1-1+noab*(h1b_1-1+noab*
     &                  (p6b_1-noab-1+nvab*(p5b_1-noab-1)))))
                   CALL TCE_SORT_4(dbl_mb(k_t),dbl_mb(k_a),
     &                  int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),
     &                  int_mb(k_range+h1b-1),int_mb(k_range+h2b-1),
     &                  4,3,2,1,1.0d0)
#endif
                   if(.not.intorb) then
#ifdef USE_LOOPS_NOT_DGEMM
                    CALL GET_HASH_BLOCK(d_b,dbl_mb(k_b),dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))))
#else
                    CALL GET_HASH_BLOCK(d_b,dbl_mb(k_t),dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))))
#endif
                   else
#ifdef USE_LOOPS_NOT_DGEMM
                    CALL GET_HASH_BLOCK_I(d_b,dbl_mb(k_b),dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))),p6b_2,p5b_2,p4b_2,p3b_2)
#else
                    CALL GET_HASH_BLOCK_I(d_b,dbl_mb(k_t),dimb,
     &                   int_mb(k_b_offset),(p6b_2-1+(noab+nvab)*
     &                   (p5b_2-1+(noab+nvab)*(p4b_2-1+(noab+nvab)*
     &                   (p3b_2-1)))),p6b_2,p5b_2,p4b_2,p3b_2)
#endif
                   end if
#ifndef USE_LOOPS_NOT_DGEMM
                   CALL TCE_SORT_4(dbl_mb(k_t),dbl_mb(k_b),
     &                  int_mb(k_range+p3b-1),int_mb(k_range+p4b-1),
     &                  int_mb(k_range+p5b-1),int_mb(k_range+p6b-1),
     &                  2,1,4,3,1.0d0)
#endif
                   if (p5b .eq. p6b) then
                    alpha = 1.0d0
                   else
                    alpha = 2.0d0
                   end if
#ifdef USE_LOOPS_NOT_DGEMM
                   call t2_p8(int_mb(k_range+h1b-1),
     &                        int_mb(k_range+h2b-1),
     &                        int_mb(k_range+p3b-1),
     &                        int_mb(k_range+p4b-1),
     &                        int_mb(k_range+p5b-1),
     &                        int_mb(k_range+p6b-1),
     &                        dbl_mb(k_a),dbl_mb(k_b),dbl_mb(k_c),
     &                        0.5d0*alpha)
#else
                   CALL DGEMM('T','N',dima_sort,dimb_sort,dim_common,
     &                  alpha,dbl_mb(k_a),dim_common,dbl_mb(k_b),
     &                  dim_common,1.0d0,dbl_mb(k_c),dima_sort)
#endif
                  END IF
                 END IF
                END IF
               END DO
              END DO
#ifdef USE_LOOPS_NOT_DGEMM
              CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_c),dimc,
     &             int_mb(k_c_offset),(h2b-1+noab*(h1b-1+noab*
     &             (p4b-noab-1+nvab*(p3b-noab-1)))))
#else
              CALL TCE_SORT_4(dbl_mb(k_c),dbl_mb(k_t),
     &             int_mb(k_range+p4b-1),int_mb(k_range+p3b-1),
     &             int_mb(k_range+h2b-1),int_mb(k_range+h1b-1),
     &             2,1,4,3,0.5d0)
              CALL ADD_HASH_BLOCK(d_c,dbl_mb(k_t),dimc,
     &             int_mb(k_c_offset),(h2b-1+noab*(h1b-1+noab*
     &             (p4b-noab-1+nvab*(p3b-noab-1)))))
#endif
#endif // USE_F90_ALLOCATABLE
              next = NXTASK(nprocs, 1)
             END IF
             count = count + 1
            END IF
           END IF
          END IF
         END DO
        END DO
       END DO
      END DO
      next = NXTASK(-nprocs, 1)
      call GA_SYNC()

#ifdef USE_F90_ALLOCATABLE
      deallocate(f_a,stat=e_a)
      deallocate(f_b,stat=e_b)
      deallocate(f_c,stat=e_c)
# ifndef USE_LOOPS_NOT_DGEMM
      deallocate(f_t,stat=e_t)
# endif
#else
# ifndef USE_LOOPS_NOT_DGEMM
      e_t=.not.MA_POP_STACK(l_t)
# else
      l_t=-12345
      e_t=.false.
# endif
      e_a=.not.MA_chOP_STACK(l_a)
#endif
      if (e_a) call errquit("MA pops a",l_a,MA_ERR)
      if (e_t) call errquit("MA pops t",l_t,MA_ERR)
      RETURN
      END



      SUBROUTINE ccsd_t2_8_spiral(d_a,k_a_offset,d_b,k_b_offset,
     1                            d_c,k_c_offset)
C     $Id: ccsd_t2.F 27404 2015-08-24 14:20:43Z jhammond $
C     This is a Fortran77 program generated by Tensor Contraction Engine v.1.0
C     Copyright (c) Battelle & Pacific Northwest National Laboratory (2002)
C     i0 ( p3 p4 h1 h2 )_vt + = 1/2 * Sum ( p5 p6 ) * t ( p5 p6 h1 h2 )_t * v ( p3 p4 p5 p6 )_v
      IMPLICIT NONE
#include "global.fh"
#include "mafdecls.fh"
#include "sym.fh"
#include "errquit.fh"
#include "tce.fh"
#include "tce_main.fh"
      integer d_a, d_b, d_c
      integer k_a_offset, k_b_offset, k_c_offset
      integer NXTASK, next, nprocs, count
      integer p3b, p4b, h1b, h2b, p5b, p6b
      integer p5b_1, p6b_1, h1b_1, h2b_1, p3b_2, p4b_2, p5b_2, p6b_2
      integer dim1,dim2,dim3,dim4,dim5,dim6
      integer dim12,dim34,dim56
      integer dima,dimb,dimc
      integer spn1,spn2,spn3,spn4,spn5,spn6
      integer spn12,spn34,spn56
      integer sym1,sym2,sym3,sym4,sym5,sym6
      integer sym12,sym34,sym56
      integer k_as, l_as, k_a, l_a
      integer k_bs, l_bs, k_b, l_b
      integer k_cs, l_cs, k_c, l_c
      integer nbh
      double precision alpha
      external NXTASK
c
c      print*,'entering ccsd_t2_8_spiral (energy)'
c
      nprocs = ga_nnodes()
      count = 0
      next = nxtask(nprocs, 1)
c
      if (.not.ma_push_get(mt_dbl,tile_dim**4,'c',l_c,k_c))
     1     call errquit('ccsd_t2_8',9,MA_ERR)
c
      do p3b = noab+1,noab+nvab
       dim3=int_mb(k_range+p3b-1)
       spn3=int_mb(k_spin +p3b-1)
       sym3=int_mb(k_sym  +p3b-1)
       do p4b = p3b,noab+nvab
        dim4=int_mb(k_range+p4b-1)
        spn4=int_mb(k_spin +p4b-1)
        sym4=int_mb(k_sym  +p4b-1)
c
        dim34 = dim3 * dim4
        spn34 = spn3 + spn4
        sym34 = ieor(sym3,sym4)
c
        do p5b = noab+1,noab+nvab
         dim5=int_mb(k_range+p5b-1)
         spn5=int_mb(k_spin +p5b-1)
         sym5=int_mb(k_sym  +p5b-1)
         do p6b = p5b,noab+nvab
          dim6=int_mb(k_range+p6b-1)
          spn6=int_mb(k_spin +p6b-1)
          sym6=int_mb(k_sym  +p6b-1)
c
          dim56 = dim5 * dim6
          spn56 = spn5 + spn6
          sym56 = ieor(sym5,sym6)
c
          dimb  = dim34 * dim56
c
          if ( (dimb.gt.0) .and. (ieor(sym34,sym56).eq.0)
     1         .and. (spn34.eq.spn56) ) then
c
          if (next.eq.count) then
c
           call tce_restricted_4(p3b,p4b,p5b,p6b,
     1                           p3b_2,p4b_2,p5b_2,p6b_2)
c
           if (.not.ma_push_get(mt_dbl,dimb,'bs',l_bs,k_bs))
     1              call errquit('ccsd_t2_8',4,MA_ERR)
           if (.not.ma_push_get(mt_dbl,dimb,'b',l_b,k_b))
     1              call errquit('ccsd_t2_8',5,MA_ERR)
c
           if(.not.intorb) then
            call get_hash_block(d_b,dbl_mb(k_b),dimb,
     1           int_mb(k_b_offset),
     2           (p6b_2 - 1 + (noab+nvab) * (p5b_2 - 1 +
     3           (noab+nvab) * (p4b_2 - 1 + (noab+nvab) *
     4           (p3b_2 - 1)))))
           else
            call get_hash_block_i(d_b,dbl_mb(k_b),dimb,
     1           int_mb(k_b_offset),
     2           (p6b_2 - 1 + (noab+nvab) * (p5b_2 - 1 +
     3           (noab+nvab) * (p4b_2 - 1 + (noab+nvab) *
     4           (p3b_2 - 1)))),p6b_2,p5b_2,p4b_2,p3b_2)
           end if
c
           call tce_sort_4(dbl_mb(k_b),dbl_mb(k_bs),
     1          dim3,dim4,dim5,dim6,2,1,4,3,1.0d0)
c
           if (.not.ma_pop_stack(l_b))
     1              call errquit('ccsd_t2_8',6,MA_ERR)
c
           do h1b = 1,noab
            dim1=int_mb(k_range+h1b-1)
            spn1=int_mb(k_spin +h1b-1)
            sym1=int_mb(k_sym  +h1b-1)
            do h2b = h1b,noab
             dim2=int_mb(k_range+h2b-1)
             spn2=int_mb(k_spin +h2b-1)
             sym2=int_mb(k_sym  +h2b-1)
c
             dim12 = dim1 * dim2
             spn12 = spn1 + spn2
             sym12 = ieor(sym1,sym2)
c
             dima  = dim12 * dim56
c
             if (dima.gt.0) then
c
              call tce_restricted_4(p5b,p6b,h1b,h2b,
     1                              p5b_1,p6b_1,h1b_1,h2b_1)
c
              if (spn34.eq.spn12) then
               if (spn56.eq.spn12) then
                if ((.not.restricted).or.((spn34+spn12).ne.8)) then
                 if (ieor(sym34,sym12).eq.0) then
                  if (ieor(sym56,sym12).eq.0) then
c
                   dimc  = dim12 * dim34
c
                   if (.not.ma_push_get(mt_dbl,dimc,'cs',l_cs,k_cs))
     1                 call errquit('ccsd_t2_8',0,MA_ERR)
c
                   call dfill(dimc,0.0d0,dbl_mb(k_cs),1)
c
                   if (.not.ma_push_get(mt_dbl,dima,'as',l_as,k_as))
     1                 call errquit('ccsd_t2_8',1,MA_ERR)
                   if (.not.ma_push_get(mt_dbl,dima,'a',l_a,k_a))
     1                 call errquit('ccsd_t2_8',2,MA_ERR)
c
                   call get_hash_block(d_a,dbl_mb(k_a),dima,
     1                  int_mb(k_a_offset),
     2                  (h2b_1 - 1 + noab * (h1b_1 - 1 + noab *
     3                  (p6b_1 - noab - 1 + nvab *
     4                  (p5b_1 - noab - 1)))))
c
                   call tce_sort_4(dbl_mb(k_a),dbl_mb(k_as),
     1                  dim5,dim6,dim1,dim2,4,3,2,1,1.0d0)
c
                   if (.not.ma_pop_stack(l_a))
     1                 call errquit('ccsd_t2_8',3,MA_ERR)
c
                   if (p5b .eq. p6b) then
                    alpha = 1.0d0
                   else
                    alpha = 2.0d0
                   end if
                   call dgemm('T','N',dim12,dim34,dim56,alpha,
     2                  dbl_mb(k_as),dim56,dbl_mb(k_bs),dim56,
     3                  1.0d0,dbl_mb(k_cs),dim12)
c
                   if (.not.ma_pop_stack(l_as))
     1                 call errquit('ccsd_t2_8',8,MA_ERR)
c
                   call ga_nbwait(nbh) ! wait until previous put of c is gone before overwriting buffer
c
                   call tce_sort_4(dbl_mb(k_cs),dbl_mb(k_c),
     1                  dim4,dim3,dim2,dim1,2,1,4,3,0.5d0)
c
                   call add_hash_block_nb(d_c,dbl_mb(k_c),dimc,
     1                  int_mb(k_c_offset),(h2b-1+noab*(h1b-1+noab*
     2                  (p4b-noab-1+nvab*(p3b-noab-1)))),nbh)
c
                   if (.not.ma_pop_stack(l_cs))
     1                 call errquit('ccsd_t2_8',11,MA_ERR)
c
                  end if
                 end if
                end if
               end if
              end if
c
             endif ! dima>0
c
            end do
           end do
c
           if (.not.ma_pop_stack(l_bs))
     1              call errquit('ccsd_t2_8',7,MA_ERR)
c
            next = NXTASK(nprocs, 1)
           end if ! next=count
           count = count + 1
c
          endif ! dimb>0
c
         end do
        end do
       end do
      end do
c
      if (.not.ma_pop_stack(l_c))
     1    call errquit('ccsd_t2_8',10,MA_ERR)
c
      next = NXTASK(-nprocs, 1)
      call ga_sync()
      RETURN
      END
